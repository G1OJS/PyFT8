<!DOCTYPE html>
<html lang="en">


<head>
	<meta charset="utf-8">
	<title>PyFT8 Live Decodes</title>
	
	<style>
		body { font-family: sans-serif; background:#111; color:#eee; margin:1em; }
		.decodes_grid {display:grid; grid-template-columns: repeat( 6, max-content) auto; background:#222; color:#8cf; }	
		.grid_row {display:contents;}
		.grid_row:hover > div{background-color: #333;}
		.grid_cell {padding:1px 5px 1px 5px}
	</style>
	
	<script>
	
		function update_grid(filename, grid_id){
			fetch(filename).catch(error=>{}).then(response => {if(!response.ok) {} else {return response.json()}}).catch(error => {})
				.then(data => {if(data.length>0) {write_grid(grid_id, data)}}).catch(error => {})
		}  
		
		function update_clock() {
			const t = new Date;
			const utc = ("0" + t.getUTCHours()).slice(-2) + ":" + ("0" + t.getUTCMinutes()).slice(-2) + ":" + ("0" + t.getUTCSeconds()).slice(-2);
			document.getElementById("clock").innerHTML = utc + " UTC";
		}
		
		function write_grid(grid_id, msgs) {
			document.getElementById(grid_id).innerHTML="";
			msgs.forEach((m) => {
				let row = document.getElementById(grid_id).appendChild(document.createElement("div"));
				row.className='grid_row';
				const fields = [m.cyclestart_str.split('_')[1], m.snr, m.freq, m.call_a, m.call_b, m.grid_rpt,''];
				fields.forEach((field, idx) => {
					const cell_div = document.createElement("div");
					cell_div.textContent = field;
					cell_div.className='grid_cell';
					row.appendChild(cell_div);
				});
				row.addEventListener("click", e => {fetch(`/select_${m.freq}_None.txt`); document.getElementById('rxFreq').innerHTML = "Rx:";}); 
				row.addEventListener("dblclick", e => {fetch(`/select_${m.freq}_${m.call_b}.txt`); document.getElementById('rxFreq').innerHTML =  "Rx:";}); 
			});
		}
		
		async function refresh_config() {
			const res = await fetch("config.json?");   
			const config = await res.json();
			document.getElementById('txFreq').innerHTML = "Tx: "+ config.txFreq;
			document.getElementById('rxFreq').innerHTML = "Rx: "+ config.rxFreq;
		}		
			
		setInterval(update_clock, 1000);
		setInterval( ()=>{
			update_grid("data.json", "current_decodes");
			update_grid("rxFreq_data.json", "rxDecodes");
			refresh_config();
		}, 250);
		
	</script>
	
</head>

<body>
	<div id='clock'></div>
	<div id='txFreq'></div>
	<div id='rxFreq'></div>
	<h3>Decodes</h3>
	<div id="current_decodes" class = "decodes_grid"></div>
	<br><br>
	<h3>Rx Freq decodes:</h3>
	<div id="rxDecodes"  class = "decodes_grid"></div>
	
</body>


</html>
