<!DOCTYPE html>
<html lang="en">


<head>
	<meta charset="utf-8">
	<title>PyFT8 Live Decodes</title>
	
	<style>
		body { font-family: sans-serif; background:#111; color:#eee; margin:1em; }
		#DecodePanelsContainer {display:grid; grid-template-columns: repeat(2, max-content); background:#555; width:max-content;}	
		.decodes_grid {display:grid; grid-template-columns: repeat( 7, max-content) auto; 
					   background:#222; color:#8cf; margin:0.5em; min-height:10em; min-width:25em;}	
		.grid_row {display:contents;}
		.grid_row:hover > div{background-color: #333;}
		.grid_row.sentTomyCall > div{background-color: #ff4d4d;}
		.grid_row.sentBymyCall > div{background-color: #e6e600;}
		.grid_cell {padding:1px 5px 1px 5px}
	</style>
	
	<script>
	
		function update_clock() {
			const t = new Date;
			const utc = ("0" + t.getUTCHours()).slice(-2) + ":" + ("0" + t.getUTCMinutes()).slice(-2) + ":" + ("0" + t.getUTCSeconds()).slice(-2);
			document.getElementById("clock").innerHTML = utc + " UTC";
		}
			
		setInterval(update_clock, 1000);

		const websocket = new WebSocket("ws://localhost:5678/");
		websocket.onmessage = (event) => {
			const m = JSON.parse(event.data)
			if(m){
				if(m.topic == 'decoder.decoding_started') {document.getElementById('all_decodes').innerHTML = "";}

				let grid_id = ''
				if(m.topic == 'decoder.decode_dict') grid_id = 'all_decodes';
				if(m.topic == 'decoder.decode_dict_rxfreq') grid_id = 'rx_decodes';
				if(m.topic == 'config.rxfreq_changed') {
					console.log(m);
					document.getElementById('rxFreq').innerHTML = m.freq;
				}
				
				if(grid_id){
					let myCall = "G1OJS";
					let row = document.getElementById(grid_id).appendChild(document.createElement("div"));
					row.className='grid_row';
					if(m.call_b == myCall) row.classList.add('sentTomyCall')
					if(m.call_a == myCall) row.classList.add('sentBymyCall')
					const fields = [m.cyclestart_str.split('_')[1], m.snr, m.freq, m.dt, m.call_a, m.call_b, m.grid_rpt,''];
					fields.forEach((field, idx) => {
						const cell_div = document.createElement("div");
						cell_div.textContent = field;
						cell_div.className='grid_cell';
						row.appendChild(cell_div);
					});
					row.addEventListener("click", e => {
						websocket.send(JSON.stringify({topic: "ui.set_rxfreq", freq: m.freq}));
						websocket.send(JSON.stringify({topic: "ui.reply_to_message", call_a:m.call_a, call_b: m.call_b, grid_rpt: m.grid_rpt, snr:m.snr}));
					}); 
				}
			} 
				
		};
		
	</script>
	
</head>

<body>
	<div id='clock'></div>
	<div >Tx freq: <span id='txFreq'></span></div>
	<div >Rx freq: <span id='rxFreq'></span></div>
	<div id = 'DecodePanelsContainer'>
		<div class = 'DecodePanel'>
			<h3>All Decodes</h3>
			<div id="all_decodes" class = "decodes_grid"></div>
		</div>
		<div class = 'DecodePanel'>
			<h3>Priority decodes:</h3>
			<div id="rx_decodes"  class = "decodes_grid"></div>
		</div>
	</div>
	
</body>


</html>
