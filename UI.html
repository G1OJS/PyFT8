<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<title>PyFT8 Live Decodes</title>
	
	<style>
		:root {
			--page-bg:#111; 	 --panel-bg:#555;
			--table-color:black; --table-bg:#666;    --table-hover-bg:#333;
			--even-bg: #8b91ad;  --odd-bg: #ad8b8b;
			--cq-bg-hl:#93bf95;  --cq-bg:#405441;
			--to-me-bg:#ff4d4d;  --by-me-bg:#e6e600;
		}

		body { font-family: sans-serif; background:var(--page-bg); color:#eee; margin:1em; }
		#App {display:inline-block;  align-content: start; width:fit-content; background:var(--panel-bg); padding:1em; height:90vh;}
		#clock {display: block; font-size: 1.17em; font-weight: bold;}
		.grid_title {display: block; font-size: 1.17em; font-weight: bold; margin-left:0.5em}
		
		#SpectrumContainer {position: relative; width: calc(2 * 25em + 2 * 1em); height: 40px;margin: 1em 0em 1em 0em; }
		#Spectrum {display: flex; justify-content: center; height: 10px; width: fit-content; background: #222;
					border: 1px solid #444; position: absolute;top: 50%;transform: translateY(-50%);}
		#Spectrum > div {display:inline-block; width:2px; height:10px;}
		.marker {position: absolute;bottom: 0; width: 1px; height: 20px;background: red;
				 color: white;font-size: 0.7em;text-align: center; transform: translateX(-50%);}
		#txMarker { background: red; bottom:20px;}
		#rxMarker { background: lime; }
								
		#DecodePanelsContainer {display:grid; grid-template-columns: repeat(2, max-content); background:var(--panel-bg); width:max-content;}	

		.decodes_grid {display:grid; grid-template-columns: repeat( 7, max-content) auto; grid-auto-rows: min-content; align-content: start; 
					   background:var(--table-bg); color:#8cf; margin:0.5em; min-height:20em; max-height:80vh; min-width:25em; overflow-y:scroll;}	

		.grid_row {display:contents; }
		.grid_row.odd > div {background-color: var(--odd-bg);}
		.grid_row.even > div{ background-color: var(--even-bg);}	
		.grid_row:hover > div {background-color: var(--table-hover-bg);}
		.grid_row.cq-highlight > div {background-color: var(--cq-bg-hl);}
		.grid_row.cq-highlight_faded > div {background-color: var(--cq-bg); transition: 1s linear all;}
		.grid_row.sentTomyCall > div {background-color: var(--to-me-bg);}
		.grid_row.sentBymyCall > div {background-color: var(--by-me-bg);}	

		.grid_cell {padding:1px 5px 1px 5px; font-weight:600; color:var(--table-color);}

	</style>
	
	<script>
		let myCall = "G1OJS";
		function update_spectrum(spectrum_power) {
			const container = document.getElementById("Spectrum");
			container.innerHTML = "";
			spectrum_power.forEach(v => {
				const cell = document.createElement("div");
				const brightness = Math.round(v * 255);
				cell.style.background = `rgb(${brightness},${brightness/2},0)`;
				container.appendChild(cell);
			});
		}
		function update_freq_markers(txFreq=0, rxFreq=0, fmin=0, fmax=3500) {
			const container = document.getElementById("Spectrum");
			const txMarker = document.getElementById("txMarker");
			const rxMarker = document.getElementById("rxMarker");
			const toPx = f => ((f - fmin) / (fmax - fmin)) * container.offsetWidth;
			if (txFreq !== undefined) txMarker.style.left = `${toPx(txFreq)}px`;
			if (rxFreq !== undefined) rxMarker.style.left = `${toPx(rxFreq)}px`;
		}
		function update_clock() {
			const t = new Date;
			const utc = ("0" + t.getUTCHours()).slice(-2) + ":" + ("0" + t.getUTCMinutes()).slice(-2) + ":" + ("0" + t.getUTCSeconds()).slice(-2);
			document.getElementById("clock").innerHTML = utc + " UTC";
			if(t.getUTCSeconds() %15 > 1) {
				for (const el of document.querySelectorAll(".cq-highlight")) {el.classList.remove("cq-highlight"); el.classList.add("cq-highlight_faded")}
			}
		}
		function add_decode_row(decode_dict, grid_id) {
			let dd = decode_dict;
			let grid = document.getElementById(grid_id)
			let row = grid.appendChild(document.createElement("div"));
			row.className='grid_row';
			let cs = dd.cyclestart_str;
			if (cs.charAt(cs.length-1) == '5'){row.classList.add('odd')} else {row.classList.add('even')}
			if(dd.call_a == myCall) {row.classList.add('sentTomyCall')}
			if(dd.call_b == myCall) {row.classList.add('sentBymyCall')}
			if(dd.call_a == "CQ") {row.classList.add("cq-highlight")}
			grid.insertBefore(row, grid.childNodes[0]);
			const fields = [dd.cyclestart_str.split('_')[1], dd.snr, dd.freq, dd.dt, dd.call_a, dd.call_b, dd.grid_rpt,''];
			fields.forEach((field, idx) => {
				const cell_div = document.createElement("div");
				cell_div.textContent = field;
				cell_div.className='grid_cell';
				row.appendChild(cell_div);
			});
			row.addEventListener("click", e => {
				update_freq_markers(rxFreq = dd.freq, txFreq=3000);
				websocket.send(JSON.stringify({	
					topic: "ui.process_clicked_message", 
					call_a:dd.call_a, call_b: dd.call_b, 
					grid_rpt: dd.grid_rpt, snr:dd.snr, freq: dd.freq
				}));
			}); 
		}

		setInterval(update_clock, 1000);
		const websocket = new WebSocket("ws://localhost:5678/");
		websocket.onmessage = (event) => {
			const dd = JSON.parse(event.data)
			if(!dd) return;
			if(dd.topic == 'transceiver.set_rxfreq') 	{update_freq_markers(rxFreq = dd.freq)}
			if(dd.topic == "freq_occ_array") 			{update_spectrum(dd.histogram)}
			if(dd.topic == 'transceiver.decode_dict')	{add_decode_row(dd, (dd.priority)? 'priority_decodes':'all_decodes')}
		}
	</script>
	
</head>

<body>
	<div id = 'App'>
		<div id='clock'></div>
		<div id="SpectrumContainer">
			<div id="Spectrum"></div>
			<div id="freqMarkers">
				<div id="txMarker" class="marker">Tx</div>
				<div id="rxMarker" class="marker">Rx</div>
			</div>
		</div>
		<div id = 'DecodePanelsContainer'>
			<div class = 'DecodePanel'>
				<div class='grid_title'>All Decodes</div>
				<div id="all_decodes" class = "decodes_grid"></div>
			</div>
			<div class = 'DecodePanel'>
				<div class='grid_title'>Priority Decodes</div>
				<div id="priority_decodes"  class = "decodes_grid"></div>
			</div>
		</div>
	</div>
	
</body>


</html>
